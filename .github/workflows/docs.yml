name: Documentation

on:
  push:
    branches: [main, develop]
    paths:
      - "docs/**"
      - "README.md"
      - "CONTRIBUTING.md"
      - "CLAUDE.md"
      - ".github/workflows/docs.yml"
  pull_request:
    paths:
      - "docs/**"
      - "README.md"
      - "CONTRIBUTING.md"
      - "CLAUDE.md"
  workflow_dispatch:

env:
  PYTHON_VERSION: "3.11"

jobs:
  # Validate documentation
  validate:
    name: Validate Documentation
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install documentation tools
        run: |
          pip install --upgrade pip
          pip install mkdocs mkdocs-material pymdown-extensions markdown-link-check

      - name: Check Markdown links
        run: |
          find . -name "*.md" -not -path "./node_modules/*" -not -path "./.venv/*" | while read file; do
            echo "Checking $file"
            markdown-link-check "$file" --config .github/markdown-link-check-config.json || true
          done

      - name: Lint Markdown files
        uses: DavidAnson/markdownlint-cli2-action@v13
        with:
          globs: |
            **/*.md
            !node_modules
            !.venv

      - name: Check for broken internal links
        run: |
          # Check for broken relative links in documentation
          python scripts/utils/check_doc_links.py || true

  # Generate API documentation
  generate-api-docs:
    name: Generate API Documentation
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
          pip install pdoc3

      - name: Generate API docs with pdoc
        run: |
          pdoc --html --output-dir docs/api app/ --force

      - name: Upload API docs
        uses: actions/upload-artifact@v4
        with:
          name: api-documentation
          path: docs/api/
          retention-days: 30

  # Check ADR completeness
  check-adrs:
    name: Check ADRs
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Verify ADR structure
        run: |
          echo "Checking ADR structure and completeness..."

          # Check if ADR index is up to date
          ADR_COUNT=$(find docs/architecture/decisions/ -name "[0-9][0-9][0-9]-*.md" | wc -l)
          INDEX_COUNT=$(grep -c "^\| \[" docs/architecture/decisions/README.md || echo "0")

          echo "Found $ADR_COUNT ADR files"
          echo "Found $INDEX_COUNT entries in index"

          # Verify each ADR has required sections
          for adr in docs/architecture/decisions/[0-9][0-9][0-9]-*.md; do
            echo "Checking $adr"

            if ! grep -q "## Context" "$adr"; then
              echo "❌ Missing 'Context' section in $adr"
              exit 1
            fi

            if ! grep -q "## Decision" "$adr"; then
              echo "❌ Missing 'Decision' section in $adr"
              exit 1
            fi

            if ! grep -q "## Consequences" "$adr"; then
              echo "❌ Missing 'Consequences' section in $adr"
              exit 1
            fi
          done

          echo "✅ All ADRs are properly structured"

  # Build documentation site
  build-docs-site:
    name: Build Documentation Site
    runs-on: ubuntu-latest
    needs: [validate, check-adrs]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install MkDocs and dependencies
        run: |
          pip install --upgrade pip
          pip install mkdocs mkdocs-material pymdown-extensions

      - name: Create mkdocs.yml if not exists
        run: |
          if [ ! -f mkdocs.yml ]; then
            cat > mkdocs.yml << EOF
          site_name: KubeSentiment Documentation
          site_description: Production-grade MLOps microservice for sentiment analysis
          site_url: https://github.com/${{ github.repository }}
          repo_url: https://github.com/${{ github.repository }}
          repo_name: ${{ github.repository }}

          theme:
            name: material
            palette:
              primary: indigo
              accent: indigo
            features:
              - navigation.tabs
              - navigation.sections
              - toc.integrate
              - search.suggest

          nav:
            - Home: README.md
            - Getting Started:
              - Quick Start: docs/configuration/QUICK_START.md
              - Developer Setup: docs/DEVELOPER_SETUP.md
            - Architecture:
              - Overview: docs/architecture.md
              - Decisions: docs/architecture/decisions/README.md
            - Configuration:
              - Overview: docs/configuration/README.md
              - Profiles: docs/configuration/PROFILES.md
              - Environment Variables: docs/configuration/ENVIRONMENT_VARIABLES.md
            - Contributing: CONTRIBUTING.md
            - AI Guide: CLAUDE.md

          markdown_extensions:
            - pymdownx.highlight
            - pymdownx.superfences
            - pymdownx.tabbed
            - admonition
            - toc:
                permalink: true
          EOF
          fi

      - name: Build documentation
        run: mkdocs build --strict

      - name: Upload documentation site
        uses: actions/upload-artifact@v4
        with:
          name: documentation-site
          path: site/
          retention-days: 30

  # Deploy to GitHub Pages (only on main branch)
  deploy-pages:
    name: Deploy to GitHub Pages
    runs-on: ubuntu-latest
    needs: build-docs-site
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download documentation site
        uses: actions/download-artifact@v4
        with:
          name: documentation-site
          path: site/

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./site
          cname: kubesentiment.example.com  # Optional: configure your custom domain
